name: Run migrations on Aiven

on:
  workflow_dispatch: {}
  push:
    branches:
      - main

jobs:
  migrate:
    runs-on: ubuntu-latest
    env:
      COMPOSER_ALLOW_SUPERUSER: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP (shivammathur)
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ secrets.GITHUB_PHP_VERSION || '8.4' }}
          extensions: |
            mbstring
            pdo_mysql
            openssl
            json
            tokenizer
            xml

      - name: Install system deps (for mysql ssl if needed)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ca-certificates

      - name: Prepare .env.ci safely
        env:
          AIVEN_DB_HOST: ${{ secrets.AIVEN_DB_HOST }}
          AIVEN_DB_PORT: ${{ secrets.AIVEN_DB_PORT }}
          AIVEN_DB_DATABASE: ${{ secrets.AIVEN_DB_DATABASE }}
          AIVEN_DB_USERNAME: ${{ secrets.AIVEN_DB_USERNAME }}
          AIVEN_DB_PASSWORD: ${{ secrets.AIVEN_DB_PASSWORD }}
          APP_KEY: ${{ secrets.APP_KEY || '' }}
          AIVEN_DB_SSL_CA: ${{ secrets.AIVEN_DB_SSL_CA || '' }}
        run: |
          echo "DB_CONNECTION=mysql" > .env.ci
          echo "DB_HOST=$AIVEN_DB_HOST" >> .env.ci
          echo "DB_PORT=$AIVEN_DB_PORT" >> .env.ci
          echo "DB_DATABASE=$AIVEN_DB_DATABASE" >> .env.ci
          echo "DB_USERNAME=$AIVEN_DB_USERNAME" >> .env.ci
          echo "DB_PASSWORD=$AIVEN_DB_PASSWORD" >> .env.ci
          
          if [ -n "$APP_KEY" ]; then
            echo "APP_KEY=$APP_KEY" >> .env.ci
          fi

          if [ -n "$AIVEN_DB_SSL_CA" ]; then
            echo "$AIVEN_DB_SSL_CA" > aiven-ca.crt
            echo "MYSQL_ATTR_SSL_CA=$(pwd)/aiven-ca.crt" >> .env.ci
          fi

      - name: Install PHP deps (composer)
        run: composer install --no-progress --no-suggest --prefer-dist --no-interaction --no-dev

      - name: Run migrations
        env:
          DB_HOST: ${{ secrets.AIVEN_DB_HOST }}
          DB_PORT: ${{ secrets.AIVEN_DB_PORT }}
          DB_DATABASE: ${{ secrets.AIVEN_DB_DATABASE }}
          DB_USERNAME: ${{ secrets.AIVEN_DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.AIVEN_DB_PASSWORD }}
        run: |
          cp .env.ci .env
          php artisan key:generate --force >/dev/null || true
          echo "Testing DB connection..."
          php -r 'try { $pdo = new PDO("mysql:host=".getenv("DB_HOST").";port=".getenv("DB_PORT").";dbname=".getenv("DB_DATABASE"), getenv("DB_USERNAME"), getenv("DB_PASSWORD")); echo "PDO OK\n"; } catch (Exception $e) { echo "PDO ERR: ".$e->getMessage()."\n"; exit(1); }'
          php artisan migrate --force --no-interaction
